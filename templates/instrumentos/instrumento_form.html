{% extends 'base.html' %}
{% load static %}

{% block title %}{% if form.instance.pk %}Editar{% else %}Novo{% endif %} Instrumento{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header">
            <h4 class="mb-0">
                <i class="fas fa-guitar"></i> 
                {% if form.instance.pk %}Editar{% else %}Novo{% endif %} Instrumento
            </h4>
        </div>
        <div class="card-body">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                
                <!-- Campos básicos do instrumento -->
                {{ form.as_p }}

                <!-- Seção de Fotos -->
                <div class="card mt-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fas fa-images"></i> Fotos do Instrumento
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Upload Múltiplo -->
                        <div class="mb-4">
                            <label for="{{ form.imagens_multiplas.id_for_label }}" class="form-label">
                                <i class="fas fa-upload"></i> Upload Múltiplo
                            </label>
                            {{ form.imagens_multiplas }}
                            <div id="multiple-preview" class="d-flex flex-wrap gap-2 mt-2"></div>
                        </div>

                        <!-- Formset de Fotos -->
                        {{ fotos_formset.management_form }}
                        {% for foto_form in fotos_formset %}
                            <div class="card mb-3">
                                <div class="card-body">
                                    {{ foto_form.id }}
                                    <div class="row align-items-center">
                                        <!-- Preview da Imagem -->
                                        <div class="col-md-3">
                                            {% if foto_form.instance.pk and foto_form.instance.imagem %}
                                                <img src="{{ foto_form.instance.imagem.url }}" 
                                                     class="img-fluid rounded" 
                                                     alt="Preview"
                                                     style="max-height: 150px;">
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Campo de Upload -->
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">Nova Imagem</label>
                                                {{ foto_form.imagem }}
                                            </div>
                                        </div>
                                        
                                        <!-- Descrição -->
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">Descrição</label>
                                                {{ foto_form.descricao }}
                                            </div>
                                        </div>
                                        
                                        <!-- Checkbox de Exclusão -->
                                        <div class="col-md-1">
                                            {% if foto_form.instance.pk %}
                                                <div class="form-check">
                                                    {{ foto_form.DELETE }}
                                                    <label class="form-check-label text-danger" 
                                                           for="{{ foto_form.DELETE.id_for_label }}">
                                                        <i class="fas fa-trash"></i>
                                                    </label>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Botões -->
                <div class="mt-4">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Salvar
                    </button>
                    <a href="{% url 'instrumento_list' %}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Preview para upload múltiplo
        $('#id_imagens_multiplas').change(function() {
            var previewDiv = $('#multiple-preview');
            previewDiv.empty();

            if (this.files) {
                Array.from(this.files).forEach(function(file) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        var img = $('<img>')
                            .attr('src', e.target.result)
                            .addClass('img-thumbnail')
                            .css('max-height', '100px');
                        previewDiv.append(img);
                    }
                    reader.readAsDataURL(file);
                });
            }
        });

        // Preview para cada campo de upload individual
        $('.foto-form input[type="file"]').change(function() {
            var input = this;
            var preview = $(this).closest('.row').find('img');
            
            if (!preview.length) {
                preview = $('<img class="img-fluid rounded" style="max-height: 150px;">');
                $(this).closest('.row').find('.col-md-3').append(preview);
            }

            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    preview.attr('src', e.target.result);
                }
                reader.readAsDataURL(input.files[0]);
            }
        });

        // Efeito ao marcar exclusão
        $('input[name$="-DELETE"]').change(function() {
            var card = $(this).closest('.card');
            if ($(this).is(':checked')) {
                card.addClass('opacity-50');
            } else {
                card.removeClass('opacity-50');
            }
        });
    });
</script>
{% endblock %}
